# **************************************************************************** #
#                                                                              #
#                                                         :::      ::::::::    #
#    Makefile                                           :+:      :+:    :+:    #
#                                                     +:+ +:+         +:+      #
#    By: yzaoui <yzaoui@student.42.fr>              +#+  +:+       +#+         #
#                                                 +#+#+#+#+#+   +#+            #
#    Created: 2024/09/11 18:44:28 by yzaoui            #+#    #+#              #
#    Updated: 2024/11/27 03:28:03 by yzaoui           ###   ########.fr        #
#                                                                              #
# **************************************************************************** #

# Couleurs
GREEN := \033[1;32m
BLUE := \033[1;34m
YELLOW := \033[1;33m
RED := \033[1;31m
NC := \033[0m  # Sans couleur

# Variables
DOCKER_COMPOSE := docker-compose
COMPOSE_FILE := srcs/docker-compose.yml
DC := $(DOCKER_COMPOSE) -f $(COMPOSE_FILE)

DATA_DIR := /home/yzaoui/data/
MARIADB_DIR := $(DATA_DIR)/mariadb
WORDPRESS_DIR := $(DATA_DIR)/wordpress

# Commandes par d√©faut
.PHONY: all build up clean help check re

# Commande principale : construire et d√©marrer
all: build up
	@echo "$(GREEN)‚úî Application construite et d√©marr√©e avec succ√®s !$(NC)"

# Verifie la presence des fichiers secrets
check:
	@bash file_secrets_exist.sh

# Construire les images Docker
build: check
	@echo "$(BLUE)üîß V√©rification des dossiers n√©cessaires...$(NC)"
	@sudo mkdir -p $(MARIADB_DIR) $(WORDPRESS_DIR)
	@echo "$(GREEN)‚úî Dossiers $(MARIADB_DIR) et $(WORDPRESS_DIR) pr√™ts !$(NC)"
	@echo "$(BLUE)üîß Construction des images Docker...$(NC)"
	@$(DC) build
	@echo "$(GREEN)‚úî Images Docker construites avec succ√®s !$(NC)"

# D√©marrer les conteneurs
up:
	@echo "$(BLUE)üöÄ D√©marrage des conteneurs Docker...$(NC)"
	@$(DC) up -d
	@echo "$(GREEN)‚úî Conteneurs Docker d√©marr√©s avec succ√®s !$(NC)"

# Nettoyer les conteneurs, volumes et r√©seaux
stop:
	@echo "$(RED)üõë Stop les conteneurs ...$(NC)"
	@$(DC) down
	@echo "$(GREEN)‚úî Arret termin√© !$(NC)"


# Nettoyer les conteneurs, volumes et r√©seaux
clean:
	@echo "$(RED)üßπ Nettoyage des conteneurs et volumes Docker...$(NC)"
	@$(DC) down -v --remove-orphans --rmi all
	@sudo rm -rf $(MARIADB_DIR) $(WORDPRESS_DIR)
	@echo "$(GREEN)‚úî Nettoyage termin√© !$(NC)"

re: clean build up

# Aide
help:
	@echo "$(YELLOW)üìù Utilisation :$(NC)"
	@echo "  $(GREEN)make$(NC)              : Construire et d√©marrer l'application"
	@echo "  $(GREEN)make check$(NC)        : Vertifie la presence de fichier secrets"
	@echo "  $(GREEN)make build$(NC)        : Construire uniquement les images Docker"
	@echo "  $(GREEN)make up$(NC)           : D√©marrer uniquement les conteneurs Docker"
	@echo "  $(GREEN)make stop$(NC)         : Arret uniquement les conteneurs Docker"
	@echo "  $(GREEN)make clean$(NC)        : Nettoyer les conteneurs et volumes Docker"
	@echo "  $(GREEN)make re$(NC)           : Nettoyer et reconstruire les images Docker et les red√©marre"
	@echo "  $(GREEN)make help$(NC)         : Afficher cette aide"
